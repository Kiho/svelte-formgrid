<div class="form-group row">
    <label class="col-4 col-form-label" for={{uuid}}>{{label}}</label>
    <div class="col-8">
        <div class="form-group">
            <input type="text"
                ref:input 
                class="form-control masked {{inputClass}}" 
                id={{uuid}} 
                placeholder={{placeholder}} 
                bind:value="text"
                readonly="{{readOnly}}"
                required="{{required}}" 
                pattern="{{pattern}}"                
                on:input="handleChange(event)"        
            />
            {{#if submit && error}}
            <div class="invalid-feedback">
                {{error}}
            </div>
            {{/if}}
        </div>       
    </div>
</div>

<script>
    import { makeUniqueId, mergeProps, formatCurrency } from './utils'

    export default {
        data() {
            return { 
                uuid: makeUniqueId(),
                placeholder: '',
                label: '',
                inputClass: '',
                value: '',
                text: '',
                class: '',
                readOnly: false,
                required: false,
                pattern: '',
                validate: null,
                submit: false,
                error: '',
                maxlength: 0,
            }
        },
        oncreate() {
            const element = this.refs.input;
            element.onkeyup = (e) => {
                if (this.get('submit')) {
                    const error = element.checkValidity() ? '' : element.validationMessage;
                    this.set({error});
                }
            };
            element.setError = (error) => {
                this.set({ error, submit: true });
            };
            mergeProps(this, 'settings');

            this.observe('value', value => {
                this.set({ text: value });
            }, { init: true });
        },
        methods: {
            handleChange(e) {
                const { maxlength, pattern, placeholder, text } = this.get();
                e.target.value = this.handleCurrentValue(e);
                // document.getElementById(uuid + 'Mask').innerHTML = this.setValueOfMask(e);
                this.set({ value: e.target.value });
            },

            handleCurrentValue(e) {
                const { charset, validExample } = this.get();
                const isCharsetPresent = charset,
                    maskedNumber = 'XMDY',
                    maskedLetter = '_',
                    placeholder = isCharsetPresent || this.get('placeholder'),
                    value = e.target.value, l = placeholder.length;
                let i, j, isInt, isLetter, strippedValue, matchesNumber, matchesLetter, newValue = '';

                // strip special characters
                strippedValue = isCharsetPresent ? value.replace(/\W/g, "") : value.replace(/\D/g, "");

                for (i = 0, j = 0; i < l; i++) {
                    isInt = !isNaN(parseInt(strippedValue[j]));
                    isLetter = strippedValue[j] ? strippedValue[j].match(/[A-Z]/i) : false;
                    matchesNumber = (maskedNumber.indexOf(placeholder[i]) >= 0);
                    matchesLetter = (maskedLetter.indexOf(placeholder[i]) >= 0);
                    if ((matchesNumber && isInt) || (isCharsetPresent && matchesLetter && isLetter)) {
                        newValue += strippedValue[j++];
                    } else if ((!isCharsetPresent && !isInt && matchesNumber) || (isCharsetPresent && ((matchesLetter && !isLetter) || (matchesNumber && !isInt)))) {
                        return newValue;
                    } else {
                        newValue += placeholder[i];
                    }
                    // break if no characters left and the pattern is non-special character
                    if (strippedValue[j] == undefined) {
                        break;
                    }
                }

                if (validExample) {
                    return this.validateProgress(e, newValue);
                }                
                return newValue;
            },

            validateProgress(e, value) {
                const { pattern, placeholder, validExample } = this.get();
                let l = value.length, testValue = '', i;
                const regex = new RegExp(this.props.pattern);

                //convert to months
                if ((l == 1) && (placeholder.toUpperCase().substr(0, 2) == 'MM')) {
                    if(value > 1 && value < 10) {
                        value = '0' + value;
                    }
                    return value;
                }

                for ( i = l; i >= 0; i--) {
                    testValue = value + validExample.substr(value.length);
                    if (regex.test(testValue)) {
                        return value;
                    } else {
                        value = value.substr(0, value.length-1);
                    }
                }

                return value;
            },
        }    
    }
</script>

<style>
    .invalid-feedback {
        display: block;
    }
</style>